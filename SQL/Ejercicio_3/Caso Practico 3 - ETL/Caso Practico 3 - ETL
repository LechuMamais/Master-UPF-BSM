{"cells":[{"cell_type":"markdown","source":["# Preparar el entorno"],"metadata":{"id":"pFoZr1zSmQcX"}},{"cell_type":"markdown","metadata":{"id":"MUXex9ctTuDB"},"source":["## Instalación de PostgreSQL e importación de librerías"]},{"cell_type":"markdown","source":["### Creación del servidor PostgreSQL\n","El siguiente código levanta un PostgreSQL en la máquina del google COLAB y lo inicializa, tanto el usuario como la contraseña para acceder a la base de datos se pueden cambiar pero por defecto serán \"postgres\" ambas.\n","\n","**También genera cuatro bases de datos distintas llamadas \"pokedexdb\", \"movimientosdb\", \"evolucionesdb\" y \"analisispokemondb\"**. Las tres primera contendrán datos sobre Pokemon, y la última se utilizará para cargar las tablas que cree el alumno y lanzar consultas SELECT para responder a las preguntas planteadas\n"],"metadata":{"id":"vUzTFQwohOsD"}},{"cell_type":"code","execution_count":null,"metadata":{"id":"YUj0878jPyz7"},"outputs":[],"source":["# Importo librería para ejecutar comandos de shell\n","import subprocess\n","\n","# Instalamos postgresql server en la máquina del COLAB\n","!sudo apt-get -y -qq update\n","!sudo apt-get -y -qq install postgresql\n","!sudo service postgresql start\n","\n","# Instalamos la librearía necesaria para realizar transformaciones en Python usando SQL\n","!pip install pandasql\n","\n","# Importamos las demás librearías utilizadas en secciones posteriores\n","import psycopg2\n","import pandas as pd\n","import requests\n","from pandasql import sqldf\n","from sqlalchemy import create_engine\n","\n","# Ejecutar el comando para verificar el estado del servicio PostgreSQL\n","result = subprocess.run(['service', 'postgresql', 'status'], stdout=subprocess.PIPE)\n","STATUS_OUTPUT = result.stdout.decode('utf-8')\n","print(STATUS_OUTPUT)\n","\n","# Verificar si la palabra \"online\" está presente en la salida del comando y que muestre online.\n","if \"online\" in STATUS_OUTPUT:\n","    print(\"PostgreSQL se encuentra online :). Se ha levantado la BBDD.\")\n","else:\n","    print(\"PostgreSQL no se encuentra online\")\n","\n","# Variables para la configuración (nombre base de datos, usuario, puerto, ...)\n","SQL_PRACTICE_DATABASE_POKEDEX_NAME=\"pokedexdb\"\n","SQL_PRACTICE_DATABASE_MOVIMIENTOS_NAME=\"movimientosdb\"\n","SQL_PRACTICE_DATABASE_EVOLUCIONES_NAME=\"evolucionesdb\"\n","SQL_PRACTICE_DATABASE_ANALISIS_NAME=\"analisispokemondb\"\n","SQL_PRACTICE_DATABASE_HOST=\"localhost\"\n","SQL_PRACTICE_DATABASE_PORT=5432\n","SQL_PRACTICE_DATABASE_USER=\"postgres\"\n","SQL_PRACTICE_DATABASE_PASS=\"postgres\"\n","\n","# Dropeamos BBDD porque no le gusta matar sesiones. (Daba error al ejecutar el Collab porque había otra sesión) + Cambio del password para el username `postgres`\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE {SQL_PRACTICE_DATABASE_POKEDEX_NAME} WITH (FORCE);\"\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE {SQL_PRACTICE_DATABASE_MOVIMIENTOS_NAME} WITH (FORCE);\"\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE {SQL_PRACTICE_DATABASE_EVOLUCIONES_NAME} WITH (FORCE);\"\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE {SQL_PRACTICE_DATABASE_ANALISIS_NAME} WITH (FORCE);\"\n","!sudo -u postgres psql -U postgres -c \"ALTER USER postgres PASSWORD '{SQL_PRACTICE_DATABASE_PASS}';\"\n","\n","# Creación de la base de datos\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE IF EXISTS {SQL_PRACTICE_DATABASE_POKEDEX_NAME};\"\n","!sudo -u postgres psql -U postgres -c \"CREATE DATABASE {SQL_PRACTICE_DATABASE_POKEDEX_NAME};\"\n","\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE IF EXISTS {SQL_PRACTICE_DATABASE_MOVIMIENTOS_NAME};\"\n","!sudo -u postgres psql -U postgres -c \"CREATE DATABASE {SQL_PRACTICE_DATABASE_MOVIMIENTOS_NAME};\"\n","\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE IF EXISTS {SQL_PRACTICE_DATABASE_EVOLUCIONES_NAME};\"\n","!sudo -u postgres psql -U postgres -c \"CREATE DATABASE {SQL_PRACTICE_DATABASE_EVOLUCIONES_NAME};\"\n","\n","!sudo -u postgres psql -U postgres -c \"DROP DATABASE IF EXISTS {SQL_PRACTICE_DATABASE_ANALISIS_NAME};\"\n","!sudo -u postgres psql -U postgres -c \"CREATE DATABASE {SQL_PRACTICE_DATABASE_ANALISIS_NAME};\""]},{"cell_type":"markdown","metadata":{"id":"9reCVv0mE_9O"},"source":["## Creación de tablas y carga de datos en el servidor PostgreSQL\n","\n","Como hemos visto, la [base de datos de Northwind](https://dbdocs.io/akweiwonder3/Northwind-Database?schema=public&view=relationships&table=order_details) tiene varias tablas, el objetivo de esta práctica es familiarizarse con los comandos de consulta de SQL y no de creación de base de datos, por lo que usaremos un script que nos creará todas las tablas y nos cargará todos los datos."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"W1eVidg3JrPV"},"outputs":[],"source":["# Función que crea la conexión a la base de datos especificada\n","def create_connection(database_name):\n","  # Primero creamos las conexiónes a las bases de datos usando la librearía psycopg2\n","  # https://pypi.org/project/psycopg2/\n","  connection = psycopg2.connect(host=SQL_PRACTICE_DATABASE_HOST,\n","                                database=database_name,\n","                                user=SQL_PRACTICE_DATABASE_USER,\n","                                password=SQL_PRACTICE_DATABASE_PASS)\n","  connection.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT);\n","\n","  # Creamos el cursor en la conexión, el cursor es nuestra \"puerta de acceso\" a la base de datos usando\n","  # la conexión configurada\n","  return connection\n","\n","# Función que ejecuta los comandos DDL en la base de datos\n","def execute_ddl(connection, ddl_command):\n","    try:\n","        # Crea el cursor para ejecutar los comandos\n","        cursor = connection.cursor()\n","\n","        # Ejecuta el comando DDL que se pasa como argumento\n","        cursor.execute(ddl_command)\n","\n","        # Cierra el cursor para liberar los recursos\n","        cursor.close()\n","\n","        print(\"Comando DDL ejecutado exitosamente.\")\n","\n","    except Exception as e:\n","        print(f\"Error al ejecutar el comando DDL: {e}\")\n","\n","# Creamos las cuatro conexiones, una a cada base de datos\n","pokedexdb = create_connection(SQL_PRACTICE_DATABASE_POKEDEX_NAME)\n","movimientosdb = create_connection(SQL_PRACTICE_DATABASE_MOVIMIENTOS_NAME)\n","evolucionesdb = create_connection(SQL_PRACTICE_DATABASE_EVOLUCIONES_NAME)\n","analisispokemondb = create_connection(SQL_PRACTICE_DATABASE_ANALISIS_NAME)\n","\n","# Función para la ejecución del archivo con los comandos ddl en la base de datos\n","def load_ddl_files_into_db(connection, file_path):\n","  with open(file_path, 'r') as file:\n","    ddl_commands = file.read()\n","  execute_ddl(connection, ddl_commands)"]},{"cell_type":"markdown","source":["### Carga de datos\n","⚠️ **ASEGÚRATE DE HABER CARGADO LOS FICHEROS NECESARIOS PARA\n","REALIZAR LA CARGA EN BASE DE DATOS**\n","* pokedexdb_ddl.sql\n","* evoluciones_ddl.sql\n","* movimientos_ddl.sql"],"metadata":{"id":"QsqsrCbTullV"}},{"cell_type":"code","source":["# Carga de tablas y datos en pokedexdb\n","load_ddl_files_into_db(pokedexdb, \"/content/pokedexdb_ddl.sql\")\n","# Carga de tablas y datos en movimientosdb\n","load_ddl_files_into_db(movimientosdb, \"/content/movimientosdb_ddl.sql\")\n","# Carga de tablas y datos en evolucionesdb\n","load_ddl_files_into_db(evolucionesdb, \"/content/evolucionesdb_ddl.sql\")"],"metadata":{"id":"B0U0ZrYsc1jA"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Función para consulta de datos con SELECT\n","def query(connection, sql):\n","  return pd.read_sql(sql, connection)"],"metadata":{"id":"ycmkFPs5lPqK"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["# Creación de la ETL\n","\n","\n","\n"],"metadata":{"id":"f3oYWtcU60et"}},{"cell_type":"markdown","source":["<div>\n","<img src=\"https://cdn.worldvectorlogo.com/logos/pokemon-23.svg\" width=\"500\"/>\n","</div>"],"metadata":{"id":"2s-kU-WyB7UY"}},{"cell_type":"markdown","source":["## Extracción\n","El objetivo es extraer las tablas necesarias para la etapa de transformación. Existen cuatro fuentes de datos:\n","* Base de datos **pokedexdb** con las siguientes tablas:\n","  * pokemon\n","  * estadisticas_base\n","  * pokemon_tipo\n","  * tipo\n","  * tipo_ataque\n","* Base de datos **movimientosdb** con las siguientes tablas:\n","  * movimiento\n","  * pokemon_movimiento_forma\n","  * forma_aprendizaje\n","  * nivel_aprendizaje\n","  * tipo_forma_aprendizaje\n","  * mo\n","  * mt\n","* Base de datos **evolucionesdb** con las siguientes tablas:\n","  * evoluciona_de\n","  * pokemon_forma_evolucion\n","  * forma_evolucion\n","  * tipo_evolucion\n","  * nivel_evolucion\n","  * piedra\n","  * tipo_piedra\n","* API pública de pokemon de la que necesitaremos extraer información sobre los huevos pokemon (egg_group)\n","  * Necesitaremos usar el endpoint [egg_group](https://pokeapi.co/docs/v2#egg-groups) para extraer la lista de tipos de huevos pokemon\n","  * Serán necesarias llamadas adicionales para extraer los pokemon que pueden nacer de cada tipo de huevo (revisar la documentación)\n","\n","Los requisitos para esta etapa de extracción son:\n","* Tendrán que extraerse los datos necesarios de cada una de las 4 fuentes de datos, no es necesario extraer aquellos que no se van a utilizar. Para ello el alumno deberá explorar y familiarizarse con los datos en las distintas tablas y bases de datos\n","* Las tablas no podrán sufrir ninguna transformación durante la etapa de extracción, es decir no se permiten usar JOINs,GROUP BYs, o cualquier otra función de transformación.\n","* Cada tabla extraída deberá de guardarse en una variable que se utilizará en la etapa de transformación\n","* Para la extracción de los datos de la API, se facilita una función que el alumno podrá usar para obtener la respuesta de la URL especificada. El alumno deberá de convertir ese JSON en la tabla/dataframe que necesite para la etapa de transformación"],"metadata":{"id":"ccIfZsp5mbC9"}},{"cell_type":"code","source":["# Función auxiliar para la llamada a la API de Pokemon\n","def api_call(url):\n","    try:\n","        response = requests.get(url)\n","        response.raise_for_status()  # Verifica si hay errores HTTP\n","        return response.json()       # Devuelve la respuesta en formato JSON\n","    except requests.exceptions.RequestException as e:\n","        print(f\"Error en la solicitud: {e}\")\n","        return None"],"metadata":{"id":"CDAEbN8Yplqn"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Ejemplo - Extraemos todos los egg-group posibles (tipos de huevos)\n","egg_groups = api_call(\"https://pokeapi.co/api/v2/egg-group/\")"],"metadata":{"id":"SKXcDNREp_aQ"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["egg_groups"],"metadata":{"id":"sjfstnx4qJDc"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Ejemplo - Extraemos los pokemon de la base de datos pokedexb\n","pokemon_table = query(pokedexdb, \"SELECT * FROM pokemon\")\n","\n","# Ejemplo - Extraemos los movimientos de la base de datos movimientosdb\n","pk_mov_forma_table = query(movimientosdb, \"SELECT * FROM pokemon_movimiento_forma\")"],"metadata":{"id":"KGy21_sO4vCJ"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["pokemon_table"],"metadata":{"id":"5hep2oO9CVAg"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["pk_mov_forma_table"],"metadata":{"id":"kh_wCOTam36B"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[],"metadata":{"id":"AqANi1-opDRG"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["## Transformación\n","El objetivo de esta fase es realizar las transformaciones necesarias en cada tabla y combinándolas entre ellas para poder responder a las preguntas planteadas.\n","\n","\n","Para ello el alumno tendrá dos opciones:\n","1.   Si se prefiere, las transformaciones se podrán realizar en Python usando la librearía Pandas\n","2.   En caso contrario, se facilitará una función **sql_trans** que el alumno podrá usar para realizar las transformaciones usando comandos SQL\n","\n","Es importante usar **únicamente las tablas creadas durante la etapa de extracción** y las tablas derivadas de ellas, **⚠️ en ningún caso será válida la creación de nuevas tablas desde base de datos/API durante la etapa de Transformación**, si se necesitan tablas adicionales se tendrán que crear en la etapa anterior.\n","\n","\n","Al final de esta etapa, el alumno tendrá un set de tablas que se cargarán en una base de datos nueva y que serán contra las que lancemos consultas SELECT para responder a las preguntas planteadas en el ejercicio. **Se valorará el número de tablas necesitadas para responder a las preguntas**, recordad que las tablas de analítica suelen estar denormalizadas por lo que se requieren un número más reducido de tablas.\n","\n"],"metadata":{"id":"lIT1JjKF8IV8"}},{"cell_type":"code","source":["# Función para realizar las transformaciones usando SQL y las tablas creadas en variables\n","# durante la etapa de Extracción\n","def sql_trans(sql_command):\n","  return sqldf(sql_command, globals())"],"metadata":{"id":"6w4KHWgS8Lxu"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Ejemplo - Uso de la función sql_trans para unir las dos tablas creadas durante\n","# la etapa de extracción (el nombre de la tabla es el nombre de la variable\n","# creada durante la etapa de extracción)\n","test_trans = sql_trans(\"\"\"\n","SELECT\n","pt.numero_pokedex,\n","pt.nombre,\n","pmft.id_movimiento\n","FROM pokemon_table pt\n","LEFT JOIN pk_mov_forma_table pmft ON pt.numero_pokedex = pmft.numero_pokedex\n","\"\"\")"],"metadata":{"id":"JJ7HKdy_uDGt"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["test_trans"],"metadata":{"id":"dj_5vewmwv2h"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[],"metadata":{"id":"JMV1qmCkyzSQ"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["## Carga de datos (Load)\n","El objetivo será cargar las tablas creadas durante la fase de Transformación (únicamente las creadas durante esta fase) en una base de datos nueva llamada **analisis_pokemon**.\n","\n","A continuación se facilita una función para la carga a la base de datos **analisispokemondb**, esta función utiliza la función [to_sql](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_sql.html), que ya se encarga de ejecutar el CREATE TABLE e INSERT DATA en base a los datos del dataframe."],"metadata":{"id":"SAJlA8ll8kr1"}},{"cell_type":"code","source":["# Definición de la función necesaria para la carga de datos en base de datos\n","def load_data(dataframe, table_name):\n","  engine = create_engine('postgresql+psycopg2://', creator=lambda get_con: analisispokemondb)\n","  dataframe.to_sql(\n","    name=table_name,\n","    con=engine,\n","    if_exists='replace',\n","    index=False\n","    )"],"metadata":{"id":"9SBnWgXE3EnA"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Ejemplo - Carga de la tabla test creada durante la etapa de Transformación\n","load_data(test_trans, 'test_trans_table')"],"metadata":{"id":"7EoZbfHry1mv"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["query(analisispokemondb, \"select * from test_trans_table\")"],"metadata":{"id":"izWRHqgLTnK_"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["# Borramos la tabla de test para dejar la base de datos limpia de nuevo\n","execute_ddl(analisispokemondb, \"DROP TABLE test_trans_table\")"],"metadata":{"id":"HEg1XlKO2450"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[],"metadata":{"id":"RR3HCn2t29mt"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["## Preguntas\n","Una vez cargados los datos resultantes de la transformación en la base de datos de analítica **analisispokemondb**, el alumno deberá de crear las consultas SELECT necesarias para contestar a las preguntas siguientes.\n","\n","**⚠️ Estas consultas sólo podrán estar dirigidas hacia la base de datos de analítica analisispokemondb**, si se necesitasen datos extra para responder a las preguntas se tendrán que añadir a la etapa de extracción, transformación y cargarlos de nuevo en la base de datos de analítica."],"metadata":{"id":"Hi_l2Xt3_dLE"}},{"cell_type":"markdown","source":["### 1. ¿Cuántos Pokémon hay de cada tipo?"],"metadata":{"id":"tNhcCKko5l66"}},{"cell_type":"code","source":[],"metadata":{"id":"L57Ph0fl5kYQ"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 2. Lista todos los niveles de evolución de los Pokémon y cuántos Pokémon evolucionan en cada nivel"],"metadata":{"id":"ei5pxwNw5rGZ"}},{"cell_type":"code","source":[],"metadata":{"id":"iGhve1EI5pvN"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 3. ¿Qué Pokémon evolucionan con un intercambio?"],"metadata":{"id":"BZJZocSl55t9"}},{"cell_type":"code","source":[],"metadata":{"id":"l4b0A_ZPxNKb"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 4. ¿Cuántos tipos de piedra de evolución hay y cuántos Pokemon distintos evolucionan con cada una de ellas?"],"metadata":{"id":"lMT3wQOk599u"}},{"cell_type":"code","source":[],"metadata":{"id":"zvJTTfWN6FOb"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 5. ¿A qué nivel aprende Mew el movimiento Metrónomo y de qué tipo es el movimiento?"],"metadata":{"id":"OrYaxQJA6J-T"}},{"cell_type":"code","source":[],"metadata":{"id":"EkIprbyCy2lD"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 6. Lista todas las evoliciones posibles de Eevee y cómo conseguir cada evolución"],"metadata":{"id":"aCy-5kmy6Xdw"}},{"cell_type":"code","source":[],"metadata":{"id":"ek1W6y2ISDp9"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 7. ¿Cuál es el Pokemon que comienza con mayor PS? ¿Y mayor velocidad?"],"metadata":{"id":"2DYGee3T6gdB"}},{"cell_type":"code","source":[],"metadata":{"id":"V5YoFg1by6H8"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 8. Lista aquellos Pokémon que pueden aprender Hoja afilada, su tipo de aprendizaje y el nivel al que lo aprenderían"],"metadata":{"id":"f5LGcXKe6m6d"}},{"cell_type":"code","source":[],"metadata":{"id":"xH6o88Jny7Dq"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 9. ¿De qué tipo de huevos puede crecer el pokemon Charmander?"],"metadata":{"id":"O2Y6wE8Z6ul1"}},{"cell_type":"code","source":[],"metadata":{"id":"ef1V0nezy8RR"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["### 10. ¿De qué tipo de huevos pueden crecer Pokémon de tipo Tierra?"],"metadata":{"id":"7lR91KCc6yor"}},{"cell_type":"code","source":[],"metadata":{"id":"dLK4VBbXy9yn"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"1owAqygNy8gGy0T34nNqJC_PbaFkL3Eut","timestamp":1713117931760},{"file_id":"https://github.com/tensorflow/io/blob/master/docs/tutorials/postgresql.ipynb","timestamp":1710332296327}]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}